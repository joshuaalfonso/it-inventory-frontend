


<div class="mb-8 ">
    <button class="flex items-center gap-2" (click)="goBack()">
        <i class="pi pi-arrow-left text-xs "></i>
        back
    </button>
</div>


<div class="bg-[var(--surface-card)] py-8 px-5 rounded-md border border-[var(--surface-border)]" >

    <div class="max-w-5xl mx-auto">
        <h1 class="text-xl font-medium mb-4">Incoming Form</h1>
        <span class="opacity-60">Fields with * are required.</span>

        <form [formGroup]="incomingForm" class="p-fluid space-y-8 mt-6">

            <div>
                <p-divider align="left" type="dashed">
                    <b>Basic Details</b>
                </p-divider>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                <fieldset class="space-y-1.5">
                    <label>
                        <span class="opacity-60 font-medium">PO #</span>
                        <span class="text-red-400">&nbsp; *</span>
                    </label>
                    <div>
                        <p-dropdown 
                            formControlName="purchase_order_id" 
                            [options]="purchaseOrderStore.purchaseOrder()"
                            optionLabel="purchase_order_number"
                            optionValue="purchase_order_id"
                            placeholder="Select a Order" 
                            appendTo="body"
                            [filter]="true"
                            [autofocusFilter]="false"
                            [showClear]="true"
                            [loading]="isPurchaseOrderLoading"
                            />
                            <!-- (onChange)="onSelectPurchaseOrder($event.value)" -->
                    </div>
                    <div class="text-sm text-red-400" *ngIf="incomingForm.get('purchase_order_id')?.hasError('min') && submitted">
                        This field is required.
                    </div>
                </fieldset>

                <fieldset class="space-y-1.5">
                    <label>
                        <span class="opacity-60 font-medium">Incoming Date</span>
                        <span class="text-red-400">&nbsp; *</span>
                    </label>
                    <div>
                        <p-calendar 
                            appendTo="body" 
                            formControlName="incoming_date" 
                            [readonlyInput]="true"
                            [showClear]="true"
                            appendTo="body"
                        />
                    </div>
                    <div class="text-sm text-red-400" *ngIf="incomingForm.get('incoming_date')?.invalid && submitted">
                        This field is required.
                    </div>
                </fieldset>

                <!-- <pre>
                    {{ selectedIncomingRow | json }}
                </pre> -->

            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                 <fieldset class="space-y-1.5">
                    <label>
                        <span class="opacity-60 font-medium">Remarks</span>
                        <span class="text-xs opacity-80">&nbsp; (Optional)</span>
                    </label>
                    <textarea 
                        rows="2" 
                        cols="30" 
                        pInputTextarea 
                        formControlName="remarks"
                    >
                </textarea>
                    <div class="text-sm text-red-400" *ngIf="incomingForm.get('incoming_date')?.invalid && submitted">
                        This field is required.
                    </div>
                </fieldset>
            </div>

            <div>
                <p-divider align="left" type="dashed">
                    <b>Item Details</b>
                </p-divider>
            </div>

            <fieldset class="space-y-4">
                    <!-- <h1 class="opacity-60 font-medium mb-4">Item Detail</h1> -->
                    <!-- <p-table
                        [value]="incomingItems.controls"
                        responsiveLayout="scroll"
                        [expandedRowKeys]="expandedRows"
                        dataKey="purchase_order_item_id"
                        *ngIf="incomingItems.length > 0"
                    >

                        <ng-template pTemplate="header">
                            <tr>
                                <th></th>
                                <th>
                                    <span class="opacity-60">Item</span>
                                </th>
                                <th>
                                    <span class="opacity-60">Delivered Qty</span>
                                </th>
                                <th>
                                    <span class="opacity-60">Open Qty</span>
                                </th>
                                <th>
                                    <span class="opacity-60">Received Qty</span>
                                    <span class="text-red-400">&nbsp; *</span>
                                </th>

                                <th class="opacity-60">Action</th>
                                <th></th>
                            </tr>
                        </ng-template>

                        <ng-template pTemplate="body" let-row let-i="rowIndex" let-expanded="expanded">
                            <tr [formGroup]="row">

                                <td>
                                    <p-button type="button" pRipple [pRowToggler]="row" [text]="true" [rounded]="true" [plain]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
                                </td>
                                <td>
                                    <div class="flex items-center gap-3">
                                        <div class="h-[50px] w-[50px]">
                                            <img 
                                                [src]="imageBaseUrl + row.value.image_name" 
                                                alt="image"
                                                class="w-full h-full object-cover rounded-md"
                                            >
                                        </div>
                                        <div>
                                            <h1>{{ row.value.item_name || '-' }}</h1>
                                            <div class="space-x-1.5 opacity-60">
                                                <span>{{ row.value.brand_name || '-' }}</span>
                                                <span>•</span>
                                                <span>{{ row.value.category_name || '-' }}</span>
                                                <span>•</span>
                                                <span>{{ row.value.item_type_name || '-' }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </td>

                                <td>
                                    {{ (row.value.delivered_quantity || 0) | number }} 
                                    /
                                    {{ (row.value.ordered_quantity || 0) | number }}
                                    &nbsp;
                                    {{ row.value.uom_name || '-' }}
                                </td>

                                <td>
                                    {{ (row.value.ordered_quantity || 0) - (row.value.delivered_quantity || 0) }} 
                                </td>

                                <td>
                                    <p-inputNumber
                                        formControlName="received_quantity"
                                        [min]="0"
                                        suffix=" {{ row.value.uom_name }}"
                                    ></p-inputNumber>
                                    <small
                                        class="text-red-400"
                                        *ngIf="
                                            row.get('received_quantity')?.hasError('min') &&
                                            submitted
                                        "
                                    >
                                        Must be greater than 0.
                                    </small>
                                    <small
                                        class="text-red-400"
                                        *ngIf="
                                            row.get('received_quantity')?.hasError('max') &&
                                            submitted
                                        "
                                    >
                                        Exceeds open quantity.
                                    </small>
                                </td>

                                <td>
                            
                                    <p-button 
                                        icon="pi pi-times"
                                        [text]="true"
                                        severity="danger"
                                        (click)="removeRow(i)"
                                    />
                                </td>

                                <td>
                                    <div *ngIf="row.get('item_type_name')?.value === 'serialized'">

                                        <div formArrayName="serial_items">

                                        <div
                                            *ngFor="let s of getSerialItems(i).controls; let j = index"
                                            [formGroupName]="j"
                                            class="p-mb-2">

                                            <input
                                            pInputText
                                            formControlName="serial_number"
                                            placeholder="Serial Number" />

                                        </div>

                                        </div>

                                        <button
                                            pButton
                                            type="button"
                                            icon="pi pi-plus"
                                            label="Add Serial"
                                            class="p-mt-2"
                                            (click)="addSerialItem(i)">
                                        </button>

                                    </div>
                                </td>

                            </tr>
                        </ng-template>

                        <ng-template pTemplate="rowexpansion" let-row let-i="rowIndex">
                        <tr>
                            <td colspan="7">
                                <div 
                                    [formGroup]="row" 
                                    class="flex flex-col items-center justify-end"
                                    *ngIf="row.get('item_type_name')?.value === 'serialized'"
                                >
                                    <div formArrayName="serial_items">
                                        <div
                                            *ngFor="let s of getSerialItems(i).controls; let j = index"
                                            [formGroupName]="j"
                                            class="p-mb-2"
                                        >
                                            <input
                                            pInputText
                                            formControlName="serial_number"
                                            placeholder="Serial Number"
                                            />
                                        </div>
                                    </div>

                                    <button
                                        pButton
                                        type="button"
                                        icon="pi pi-plus"
                                        label="Add Serial"
                                        class="p-mt-2"
                                        (click)="addSerialItem(i)"
                                    ></button>
                                </div>
                            </td>
                        </tr>
                        </ng-template>



                    </p-table> -->

                    <div class="flex flex-col gap-4" *ngIf="incomingItems.length > 0">

                        <!-- Header -->
                        <div
                            class="grid grid-cols-[40px_2fr_1fr_1fr_1fr_80px] gap-3 px-3 py-2 text-sm opacity-60 font-medium"
                        >
                            <div></div>
                            <div>Item</div>
                            <div>Delivered Qty</div>
                            <div>Open Qty</div>
                            <div>
                            Received Qty
                            <span class="text-red-400">*</span>
                            </div>
                            <div>Action</div> 
                        </div>

                        <!-- Rows -->
                        <div
                            class="rounded-md border border-[var(--surface-border)]"
                            *ngFor="let row of incomingItemGroups; let i = index"
                        >
                            <div
                                class="grid grid-cols-[40px_2fr_1fr_1fr_1fr_80px] gap-6 items-center
                                    border-b border-[var(--surface-border)] px-3 py-3 "
                                [formGroup]="row"
                            >
                                <!-- Expand -->
                                <div class="grid place-items-center">
                                    <button
                                        type="button"
                                        class="text-gray-500 hover:text-gray-700"
                                        (click)="expandedRows[i] = !expandedRows[i]"
                                    >
                                        <i
                                            class="pi"
                                            [ngClass]="expandedRows[i] ? 'pi-chevron-down' : 'pi-chevron-right'"
                                        ></i>
                                    </button>
                                </div>

                                <!-- Item -->
                                <div class="flex items-center gap-3">
                                    <img
                                    [src]="imageBaseUrl + row.value.image_name"
                                    class="w-[50px] h-[50px] rounded-md object-cover"
                                    />
                                    <div>
                                    <h1 class="font-medium">
                                        {{ row.value.item_name || '-' }}
                                    </h1>
                                    <div class="text-xs opacity-60 space-x-1">
                                        <span>{{ row.value.brand_name || '-' }}</span>
                                        <span>•</span>
                                        <span>{{ row.value.category_name || '-' }}</span>
                                        <span>•</span>
                                        <span>{{ row.value.item_type_name || '-' }}</span>
                                    </div>
                                    </div>
                                </div>

                                <!-- Delivered -->
                                <div class="text-sm">
                                    {{ row.value.delivered_quantity || 0 }}
                                    /
                                    {{ row.value.ordered_quantity || 0 }}
                                    {{ row.value.uom_name }}
                                </div>

                                <!-- Open -->
                                <div class="text-sm">
                                    {{ (row.value.ordered_quantity || 0) - (row.value.delivered_quantity || 0) }}
                                </div>

                                <!-- Received -->
                                <div>
                                    <p-inputNumber
                                        formControlName="received_quantity"
                                        [min]="0"
                                        suffix=" {{ row.value.uom_name }}"
                                        class="w-full"
                                    ></p-inputNumber>

                                    <small
                                        class="text-red-400 text-xs"
                                        *ngIf="row.get('received_quantity')?.hasError('min') && submitted"
                                    >
                                        Must be greater than 0
                                    </small>

                                    <small
                                        class="text-red-400 text-xs"
                                        *ngIf="row.get('received_quantity')?.hasError('max') && submitted"
                                    >
                                        Exceeds open quantity
                                    </small>
                                </div>

                                <!-- Action -->
                                <div class="flex justify-center">
                                    <p-button
                                    icon="pi pi-times"
                                    text
                                    severity="danger"
                                    (click)="removeRow(i)"
                                    ></p-button>
                                </div>
                            </div>

                            <!-- Expanded Row -->
                            <div
                                *ngIf="expandedRows[i]"
                                class=" rounded-md px-16 py-4"
                                [formGroup]="row"
                            >

                                <div *ngIf="row.get('item_type_name')?.value === 'serialized'">

                                     <!-- <hr class="border border-[var(--surface-border)]"> -->

                                     <div class="flex gap-3">
                                        <div class="flex-1">
                                            <input 
                                                type="text" 
                                                pInputText 
                                                [(ngModel)]="serialNumber" 
                                                [ngModelOptions]="{standalone: true}"
                                                placeholder="Serial Number" 
                                                class="w-full" 
                                            />
                                        </div>
                                        <p-button icon="pi pi-plus" label="add" />
                                        <p-button icon="pi pi-camera" label="Scan" severity="secondary" />
                                     </div>

                                    <div formArrayName="serial_items" class="space-y-2">
                                        <div
                                            *ngFor="let s of getSerialItems(i).controls; let j = index"
                                            [formGroupName]="j"
                                        >

                                            <!-- <input type="text" pInputText formControlName="serial_number" placeholder="Serial Number" class="w-full" /> -->
                                             <span>{{ s.value.serial_number }}</span>
                                        </div>
                                    </div>

                                    <!-- <div class="flex items-center justify-end">
                                        <p-button
                                            type="button"
                                            icon="pi pi-plus"
                                            label="Add Serial"
                                            class="mt-3"
                                            (click)="addSerialItem(i)"
                                        ></p-button>
                                    </div> -->

                                </div>
                            </div>

                        </div>

                        </div>



                    <div class="flex items-center justify-end">
                        <!-- <p-button 
                            icon="pi pi-plus"
                            [text]="true"
                            severity="success"
                            (click)="addRow()"
                        /> -->
                        <div *ngIf="totalQuantity">
                            <span>Total Quantity: </span>
                            <span> &nbsp; {{ (totalQuantity || 0) | number  }}</span>
                        </div>
                    </div>

                    <div
                        class="grid place-items-center my-5 space-y-2" 
                        *ngIf="incomingItems.length == 0"
                    >

                        <div class="h-[200px] w-[200px]">
                            <img 
                                src="/assets/icons/empty-pana.svg" 
                                class="w-full h-full object-cover" 
                            />
                        </div>

                        <h1 class="text-base font-semibold">No Items yet</h1>
                        <!-- <p class="opacity-60">Start adding by selecting PO</p> -->

                        <button
                            class="bg-teal-400/10 text-teal-400 font-medium px-3 py-1 rounded-md"
                            (click)="addItem()" 
                        >
                            Add Item
                        </button>

                    </div>
                        
                </fieldset>

        </form>
    </div>


</div>

<div class="mt-4 flex justify-end items-center">
    <p-button 
        label="Create"
        (click)="onSubmit()" 
    />
</div>


<p-dialog 
    #purchaseOrderDialog 
    header="Purchase Order Detail" 
    [(visible)]="isPurchaseOrderVisible" 
    [modal]="true" 
    [style]="{ width: '25rem' }"
    [focusOnShow]="false"
>

        <span class="p-text-secondary block mb-5">Please click close after selecting items.</span>


        <div *ngIf="!purchaseOrder">
            No data found.
        </div>

        <div *ngIf="purchaseOrder">

            <h1 class="font-bold text-xl mb-4">
                {{ purchaseOrder.purchase_order_number || '-' }}
            </h1>

            <div *ngIf="purchaseOrder.purchase_order_item.length > 0">
                <p-table 
                    [value]="purchaseOrder.purchase_order_item" 
                    [tableStyle]="{ 'min-width': '50rem' }"
                    styleClass="p-datatable-gridlines"
                    [(selection)]="selectedIncomingRow"
                    (onRowSelect)="onSelectItem($event.data)" 
                    (onRowUnselect)="onRemoveItem($event.data)" 
                >
                    <ng-template pTemplate="header">
                        <tr>
                            <!-- <p-tableHeaderCheckbox /> -->
                            <th style="width: 4rem"></th>
                            <th>Item</th>
                            <th>Ordered Qty</th>
                            <th>Delivered Qty</th>
                            <th>Open Qty</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-item>
                        <tr >
                            <td>
                                <p-tableCheckbox [value]="item" />
                            </td>

                            <td>
                                <div class="flex items-center gap-3">
                                    <div class="h-[50px] w-[50px]">
                                        <img 
                                            [src]="imageBaseUrl + item.image_name" 
                                            alt="image"
                                            class="w-full h-full object-cover rounded-md"
                                        >
                                    </div>
                                    <div>
                                        <h1>{{ item.item_name || '-' }}</h1>
                                        <div class="space-x-1.5 opacity-60">
                                            <span>{{ item.brand_name || '-' }}</span>
                                            <span>•</span>
                                            <span>{{ item.category_name || '-' }}</span>
                                            <span>•</span>
                                            <span>{{ item.item_type_name || '-' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {{ (item.ordered_quantity || 0) | number }}
                                <span>&nbsp; {{ item.uom_name || '-' }}</span>
                            </td>
                            <td>
                                {{ (item.delivered_quantity || 0) | number }}
                                <!-- <span>&nbsp; {{ item.uom_name || '-' }}</span> -->
                            </td>
                            <td>{{ (item.ordered_quantity || 0) - (item.delivered_quantity || 0) | number }}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>


        </div>
       
        <ng-template pTemplate="footer">
  
            <p-button 
                icon="pi pi-times"
                label="Close" 
                (onClick)="isPurchaseOrderVisible = false" 
              />
        </ng-template>
</p-dialog>